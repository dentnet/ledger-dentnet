#include <cassert>
#include <cstdint>
#include <cstdio>
#include <iostream>
#include <string>

#include "app_mode.h"
#include "hexutils.h"
#include "metadata_parser.h"
#include "metadata_proof.h"
#include "metadata_reader.h"
#include "parser.h"
#include "parser_common.h"
#include "parser_impl.h"

#ifdef NDEBUG
#error "This fuzz target won't work correctly with NDEBUG defined, which will cause asserts to be eliminated"
#endif

using std::size_t;

const std::string metadataPolkadotSystemSetStorage =
    "68000341000000030102082873705f72756e74696d65384d756c74695369676e6174757265011c456432353531390400169d0101486564323535313"
    "93a3a5369676e617475726500c902082873705f72756e74696d65384d756c74695369676e6174757265011c53723235353139040016cd0201487372"
    "32353531393a3a5369676e617475726504c902082873705f72756e74696d65384d756c74695369676e617475726501144563647361040016d102014"
    "065636473613a3a5369676e617475726508c9020c1c73705f636f72651c73723235353139245369676e617475726500040016a10101205b75383b20"
    "36345dcd020c1c73705f636f7265146563647361245369676e6174757265000400160102017c5b75383b205349474e41545552455f53455249414c4"
    "95a45445f53495a455dd10210306672616d655f73797374656d28657874656e73696f6e733c636865636b5f6d6f7274616c69747938436865636b4d"
    "6f7274616c697479000400168506010c4572618106102873705f72756e74696d651c67656e657269630c6572610c45726101244d6f7274616c32313"
    "4040003005903850610306672616d655f73797374656d28657874656e73696f6e732c636865636b5f6e6f6e636528436865636b4e6f6e6365000400"
    "110120543a3a4e6f6e63658906086870616c6c65745f7472616e73616374696f6e5f7061796d656e74604368617267655472616e73616374696f6e5"
    "061796d656e7400040013013042616c616e63654f663c543e8d060c1c73705f636f72651863727970746f2c4163636f756e74496433320004001604"
    "01205b75383b2033325d000003200000000304083c7072696d69746976655f74797065731048323536000400160401205b75383b2033325d0c00020"
    "310000314000000035c0840706f6c6b61646f745f72756e74696d652c52756e74696d6543616c6c011853797374656d040016cc01ad0173656c663a"
    "3a73705f6170695f68696464656e5f696e636c756465735f636f6e7374727563745f72756e74696d653a3a68696464656e5f696e636c7564653a3a6"
    "4697370617463680a3a3a43616c6c61626c6543616c6c466f723c53797374656d2c2052756e74696d653e00c80c306672616d655f73797374656d18"
    "70616c6c65741043616c6c012c7365745f73746f726167650401146974656d7316d001345665633c4b657956616c75653e10cc000216d4d00004081"
    "6101610d40c2873705f72756e74696d65306d756c746961646472657373304d756c746941646472657373010849640400160001244163636f756e74"
    "49640019010c2873705f72756e74696d65306d756c746961646472657373304d756c7469416464726573730114496e64657804001501304163636f7"
    "56e74496e6465780419010c2873705f72756e74696d65306d756c746961646472657373304d756c746941646472657373010c52617704001610011c"
    "5665633c75383e0819010c2873705f72756e74696d65306d756c746961646472657373304d756c74694164647265737301244164647265737333320"
    "400160401205b75383b2033325d0c19010c2873705f72756e74696d65306d756c746961646472657373304d756c7469416464726573730124416464"
    "7265737332300400165c01205b75383b2032305d1019010c1c73705f636f72651c65643235353139245369676e617475726500040016a10101205b7"
    "5383b2036345d9d0100034000000003a10168140800009508000096080000970800009808000099080000c80b00009f0c0000c90c0000ca0c000065"
    "060000660600006806000069060000a10600000a0700003a07000041070000420700006507000066070000670700006807000069070000be070000b"
    "f0700002d016789ced43a0367885ff3078f5e2fc7a4f410e0de25fc61592fd571a3ddd0992308c0aeb6a568a4d74f481cbb138a78dfb713c343c20a"
    "1050c5235b1ad89073b2cb142cc9a3b3bdfcd9ed0e511c36917ae671cc251a6d7fd3d5f85d9a5e7c3fa5c3f90b255b14f7de7904a8a82d6f793db29"
    "ea554a3a72d5d7cc8ce6d7737bc0173743df5f2da9aabcea1dd2dbd238bddc043e8ea38535ab63a7992bc96849747568b99743425c3b7952dce707b"
    "4f9a80fa40118ef72aaf9dc3f5395ae644511d49fed1b2ae921ef2b57e8ef1f97884c95cb192eb72aff9121b362d353c7607b20d63fcfc9db22e37f"
    "bd115d20c0a95bcff4e1a2d198c2c46f56cddbb36c1e3337096be7ded3a487b812f391541f80b87b4a6e5b02e6547f6e87f41a60199a4930eaf1a76"
    "2ca945720736ba47951700d451e5a5632995a575be272e8299e1210f02304678945b1d3661789ee3b3c94b09cb8210d6997b610086b2f768f914314"
    "cbd4b0da441e1d200352230239b6bb43a187e22d1ee788737c0fb38e06a84ae1d7465e3499cb65f80604723105a3c752946df8f689de24809d9a32e"
    "785697c476acf0de41e9616da3b42a902176dd8708edd4fded453de1482673dd739e1126551d7657b1d4c973a62afb0fb87ca4023059f8778235367"
    "e3664ffb34c6d651737c1c29bf8b17a01b7c6524a998d958d03052f7294aaceaa07c0ce2ccc35cd08872f436caf9d39af986a70fe2923b8a433472c"
    "431b18b01a3801d02f187102464cda4c9376ec604df012735ff23739dfc232e0daade3f6e438786f035cf6c8a343efefbf92dfbdf739ca2cb82d84a"
    "288bace231a23497fb059ba78dde5d7b41ea49145f8878601aca7c0aed379d9dab0fdf35d4c262dff0664845b741fff26953a5d2c7a489d907b1865"
    "51a787f47de0fd1d606dfdb6d0c31b568b1e6d21caec884c91aa88564aff5e9c8ee47b3753091ee7fe59d3d68b279dee5d8c28cdd86428a5f1789a4"
    "40bf1f887e14bc68dca767b0b76b9e253c7f7e4abaf9fcfa4dbcc7a6f537dbed88cf50a7d9686710ddb0144d59907efacb765d05c3456f7061587dc"
    "c567a0df71a6dd7c4ac26db7a7b02ceb2288c626f5bcf01070c2afbc21c1c43c46ce1aeeb85be2f68f678808d510dc32a262813fff8b1e139159d42"
    "11cf0b03493e37fd6bcf775836baf39819f5526c469f4ecd103a030ea1c1b6b9e7150c8459706a117a7ad7287d4239d1bd356413603283769507668"
    "68ffcbcd572f8a154c4158c0699d3c62e1f73ec22947d631a1a9bc7bfce72905a6768b221e3aa1dd2bfc2de56097aeaadad6a55c41adb6c33f05dbe"
    "72a15a63b12848bed0830010026c09b8536f16df2e47b6bbe37b220209ab01b24f486cecdd1275323a6b57e257727a078a0ecf35cc230f109b9b6fe"
    "bea4f045685937351667b4f9c5d203ac57a2b6192da66752008cbe46e4b9a4d1adcd5c738939da73dd4e98c81244e77c304fd3814e151905ab6499c"
    "76ccb290d3cc9fa2f41bd00139140b7206e31ff9d98e4beef1d1a2e20bbc4a225773b9327590503729e589420b1a75d86eaabff22d7ceb0a3bce798"
    "5ac4ce86e36c57c1716dc9c7e103b2ad5a424a8d0e86dfa17f9a0777cea925237e5e01f242991ef6c33a086b7c0e4bc8c497b88128da54855c26a44"
    "774166c1c0c12df62186723dc72187a726913882137fa3921e1778031871fbc47ddf9eaa50b0a79749430145a6491ea04b932fad174e2c3ba25099c"
    "df2ff6fb93e59312a2391582fa6301d039ad6cb34be631295a583d696acdf81f60aef2933d103a4f6838dc8a34267a4bc34f96ba701316325e7166e"
    "9d994eaafae1a36114b99fc77cd003b826a4eb3284fb97de0abe331c71e30d7222190ed1ceb320a5e235f247ae4a367e39345f284d7d157b7dab0b1"
    "1918ccc7d855c89675584a017fae32fbe8f6e6a00d4f2214646fb95b88b2be76a5f3183f890b6757cf45d3847c454a1bf766c077626a49c05f295b5"
    "df428a3792a70b1150f81b8f2dfbd1614c71be9c51a53a8cc366b5da97f26546986169bac68e066dc4921c50d3d31f7b93167d1ff3f42b1237a45ff"
    "bf39116c9291fa5754e677cdb0b6c1c29094f048d777bd704b36ab9f431fdee3f8440ad530699b9b81bece174a4c0e6c8a849749b3230acc366d2f1"
    "faf5663f98fbe2bde7db2293400e29779d28c921ff4517841e98812fcd13389cab1b67d198b1b829616cc39a2f77f50ee706247fa049e8d3a3e257d"
    "d48632b9fc089004d2df41d90850974446ffe8b0648e52d9f2ae0629703dc728d139ef1c34a7039be70652fa74c1e00c8c001eb27a718a4fb722b56"
    "dca6f8753b6cf462f6d3ec795ad9c7f4c5e861eb06b9a4ab41938e5d77ac428a37676f572d2e4047e06998d545f211cbf711f51da8f98a71a6a8e39"
    "068172ccff0503c7ebda458d389ebbbd592d8d5d58d6ba3e8f3e0453b21987e889c06a2ead245cf0e7d259a969e43860e7f7fbfb6963b7a6fafe0a7"
    "fcf26daa836b4657e1f6da102da961a8d59f57eaef8df12eab6921ef9b6c8ebc7d374200e266a5e9c41b64852e7a200bb99974eed6b8fd1e5080f86"
    "dd47b0e14c1b5d14f816d19dd01c42ed8ac8df8e0e1bc4ba6c84115749a32cd464b7596912e5aed4e3acc77016ade848daafb938d5f7f4744d7adfd"
    "ccc862df5c8ca239a35a773543764f1d1a26072c68f516029097636910f24e375120482d2fc6daf35102f7c29bd9813d030d156bd0face37a47937b"
    "e063b0266760766cd46d835764bdff25e24df5ed38f32e0d8da21c1c8de4c9ee8a0b7a4f70c08c9efc0ace26aef368b8aa5c34bef19a95ec79f4a17"
    "a53cb7b46b03b872e2eeb8d11b608248a4bf93910ca8dcbb9ddbb45f6b6f137da120bdd23b2835495bdb293da5f7195f338b604036fc9934315b19b"
    "8879243319d62ec6683a4929a57b63a0e8448039385ad11e6e71250c61bc4e8f0958fc30aa2702eae5209084ab6c5b03c3e178acb187ce8cafacd47"
    "717fc1c95e36d0451a59ac29716afcb1c9b60ae84e1cddf6eb72179718426c7e76996a32f8d3a1c3571406e43c3c92e66a85453bafc09db87a58237"
    "38aee33d23d358145b3538e76d4659e74cd5f5548871e6dd103ba4af5d6ff6f170de073361d9ea751683cba3837e2820de029ed100c52ed28670005"
    "1b1dc8d94fc887a7e3bf71fe5cae00dc09e26c5beaf0bb8dc2785524253ac88b3dd7a38a6b53c4b86878140c4747eb4b3e24ce100674c456d5a40c2"
    "471bd6f9f539778f78129b9790936115677923895ffce590b5b70cd637ae1c497718a5cd5178022f4ae71d85b12d9fcf1766754b3548fef3621b3fb"
    "9b21b11e9f902f8cd4e4ef20f0556d5ac48834de84ba0a9cea50416190116c816c9022448436865636b4e6f6e5a65726f53656e6465721515404368"
    "65636b5370656356657273696f6e150538436865636b547856657273696f6e150530436865636b47656e6573697315160c38436865636b4d6f72746"
    "16c697479168106160c28436865636b4e6f6e6365168906152c436865636b5765696768741515604368617267655472616e73616374696f6e506179"
    "6d656e74168d06154850726576616c6964617465417474657374731515104a0f0020706f6c6b61646f7400000a0c444f54";

extern "C" int LLVMFuzzerTestOneInput(const uint8_t *data, size_t size) {
    if (size > UINT16_MAX || size <= 1) {
        return 0;
    }

    parser_error_t error = parser_unexpected_error;

    uint8_t metadataBuffer[4000] = {0};
    const uint16_t metadataLen =
        parseHexString(metadataBuffer, sizeof(metadataBuffer), metadataPolkadotSystemSetStorage.c_str());

    // ById(52) --> Type { path: [], type_def: Sequence(ById(53)), type_id: 52 },
    const TypeRef_t type = {.index = ById, .byId = 52};
    parser_context_t blob = {.buffer = data, .bufferLen = static_cast<uint16_t>(size), .offset = 0};
    parser_context_t metadata = {.buffer = metadataBuffer, .bufferLen = metadataLen, .offset = 0};
    RegistryEntry_t tmpEntry = {0};
    PrintItem_t printItem = {0};
    printItem.printing = true;
    printItem.target = 1;

    error = parseTypeRef(&blob, &metadata, &tmpEntry, &type, &printItem);
    if (error != parser_ok) {
        return 0;
    }

    return 0;
}
